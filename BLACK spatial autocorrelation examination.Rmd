---
title: "Spatial autocorrelation"
author: "Eddie Wu"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This .Rmd file is to test the spatial autocorrelation in our black carp data file, and try to find the best distance that reduces the spatial autocorrelation when doing subsampling. In this file, we:

1. Show the distribution of our data points on a map.

1. Use moran's I test to test the global spatial autocorrelation in our dataset.

2. Use the correlog plots to examine how spatial autocorrelation changes with distances.

3. Use the variogram to further test point 2.

4. Subsample at 250 km and 550 km, and check the local moran's I after sub-sampling to see if spatial autocorrelation has been reduced.

5. Conduct latitudinal stratification analysis.

6. Look at the Chinese dataset - 17 data points.



```{r library, warning=FALSE, message=FALSE}
library(gstat)
library(ggplot2)
library(dplyr)
library(spdep)
library(sp)
library(nlme)
library(ape)
library(MuMIn)
library(raster)
library(ncf)
library(knitr)
library(rnaturalearth)
library(sf)
```

```{r data import}
## Import location data
location <- read.csv("location_no_temps.csv")
location <- unique(location) # remove duplicating locations

# Clean the data
carp <- read.csv("eddie_carp_new.csv")
carp.r <- carp %>% 
  filter(sex != "male") %>% # keep the non-male data points
  distinct(location, .keep_all = TRUE) # remove all repeating locations

## Download one file to get the spatial points
# (this defines what projection to use when converting to spatial objects)
tmin.1979 <- brick("cpc/tmin.1979.nc", varname = "tmin")
tmin.1979<-rotate(tmin.1979)
```


## Data distribution

```{r distribution}
## Get the world data
world <- ne_countries(scale = "small", returnclass = "sf")

## Plots (global plot)
world %>% 
  filter(admin != "Antarctica") %>%
  # remove antarctica
  ggplot()+
  geom_sf()+
  geom_point(aes(x=Longitude, y=Latitude), data = location,
             size = 1, color = "darkred")+
  theme_bw()+
  xlab("Longitude") + ylab("Latitude")
```


## Calculate the residuals from the linear model

```{r model}
# Define the model
lm.annual <- lm(log(carp.r$AAM)~carp.r$AnnualTemp) # Annual temperature
lm.cold <- lm(log(carp.r$AAM)~carp.r$ColdTemp) # Cold temperature
lm.warm <- lm(log(carp.r$AAM)~carp.r$WarmTemp) # Warm temperature

# See the results
summary(lm.annual)
summary(lm.cold)
summary(lm.warm)
```



## Global spatial autocorrelation

```{r global}
## Make spatial dataframe
coords <- data.frame("long"=location[,3],"lat"=location[,2])
df <- data.frame(a = 1:nrow(location[3]))
spatial.data <- SpatialPointsDataFrame(coords,df,proj4string = tmin.1979@crs)

# Get a distance matrix from all points
dists <- spDists(spatial.data, longlat = TRUE)

## Run the Moran.I test on the residuals
Moran.annual <- Moran.I(lm.annual$residuals, dists)
Moran.cold <- Moran.I(lm.cold$residuals, dists)

global.moran <- data.frame(
  Model = c("Moran.annual", "Moran.cold"),
  Observed = c(Moran.annual$observed, Moran.cold$observed),
  Expected = c(Moran.annual$expected, Moran.cold$expected),
  sd = c(Moran.annual$sd, Moran.cold$sd),
  p.value = c(Moran.annual$p.value, Moran.cold$p.value)
)

kable(global.moran)
```

There is no global spatial autocorrelation for the entire dataset.


## Local spatial autocorrelation

```{r correlog}
## Annual temperature
par(mfrow=c(2,1),mar=c(4,4,2,2))

# Use the coorelog function to develop the relationship
test <- correlog(coords$long, coords$lat, lm.annual$residuals,
                 increment=50, resamp=500, latlon=T)

# Plot with the entire distance range
plot(test, main="Annual Average Temperature Regression Residuals")
abline(h=0)
text(17400, min(test$correlation)+1, "A", cex=1.5)

# Reduce the distance range to 2500 km
plot(test, main="", xlim=c(0,2500))
abline(h=0)
text(2500, min(test$correlation)+1, "B", cex=1.5)


## Cold temperature
par(mfrow=c(2,1),mar=c(4,4,2,2))

# Use the coorelog function to develop the relationship
test <- correlog(coords$long, coords$lat, lm.cold$residuals,
                 increment=50, resamp=500, latlon=T)

# Plot with the entire distance range
plot(test, main="Cold Quarter Temperature Regression Residuals")
abline(h=0)
text(17400, min(test$correlation)+1, "A", cex=1.5)

# Reduce the distance range to 2500 km
plot(test, main="", xlim=c(0,2500))
abline(h=0)
text(2500, min(test$correlation)+1, "B", cex=1.5)
```

In general, the correlog plots suggest that for both temperature, 600 km is a good distance to reduce local spatial autocorrelation.


## Variogram

```{r variogram}
## Create a data frame to store the necessary information
vario.data <- data.frame(residuals = lm.annual$residuals,
                         x = coords$long, y = coords$lat)

# Turn them to spatial points using our projection
geo.spatial<-SpatialPoints(coords, proj4string = tmin.1979@crs)


## Variogram
vario <- variogram(vario.data$residuals~1, data = geo.spatial)
plot(vario)
```


If we pick 250 km as the cutoff distance for sub-sampling, we would have 20 location points.

If we pick 550 km as the cutoff distance for sub-sampling, we would have only 12 location points.



## Subsampling at 250km

Here, we try to sub-sample at 250km and check the local moran's I (correlog plot) after sub-sampling.

### Local moran's I - annual 250

```{r subsample local moran annual 250, fig.width=14, fig.height=12, results='hide'}
# Store the r2 values
r2.250.raw <- matrix(NA,10, 2)
colnames(r2.250.raw) <- c("annual","cold")

table(carp.r$spatial.code.250)

par(mfrow = c(5, 2))
par(mar=c(1,1,1,1))

## Check the local moran's results after sub-sampling
for (i in 1:10){
  sub <- carp.r %>% group_by(spatial.code.250) %>% sample_n(size=1)
  reg.sub.annual <- lm(log(sub$AAM)~sub$AnnualTemp)
  test <- correlog(sub$longitude, sub$latitude, reg.sub.annual$residuals,
                   increment=50, resamp=500, latlon=T)
  plot(test, main="", xlim=c(0,2500))
  abline(h=0)
  r2.250.raw[i,1] <- summary(reg.sub.annual)$adj.r.squared #get the r2
}
```


### Local moran's I - cold 250

```{r subsample local moran cold 250, fig.width=14, fig.height=12, results='hide'}
table(carp.r$spatial.code.250)

par(mfrow = c(5, 2))
par(mar=c(1,1,1,1))

## Check the local moran's results after sub-sampling
for (i in 1:10){
  sub <- carp.r %>% group_by(spatial.code.250) %>% sample_n(size=1)
  reg.sub.cold <- lm(log(sub$AAM)~sub$ColdTemp)
  test <- correlog(sub$longitude, sub$latitude, reg.sub.cold$residuals,
                   increment=50, resamp=500, latlon=T)
  plot(test, main="", xlim=c(0,2500))
  abline(h=0)
  r2.250.raw[i,2] <- summary(reg.sub.cold)$adj.r.squared #get the r2
}
```


Subsampling at 250 km does not reduce the spatial autocorrelation in our dataset.



## Subsampling at 550km

Now, we try to subsample at a larger distance - 550km.

### Local moran's I - annual 550

```{r subsample local moran annual 550, fig.width=14, fig.height=12, results='hide'}
table(carp.r$spatial.code.550)

# Store the r2 values
r2.550.raw <- matrix(NA,10, 2)
colnames(r2.550.raw) <- c("annual","cold")

par(mfrow = c(5, 2))
par(mar=c(1,1,1,1))

## Check the local moran's results after sub-sampling
for (i in 1:10){
  sub <- carp.r %>% group_by(spatial.code.550) %>% sample_n(size=1)
  reg.sub.annual <- lm(log(sub$AAM)~sub$AnnualTemp)
  test <- correlog(sub$longitude, sub$latitude, reg.sub.annual$residuals,
                   increment=50, resamp=500, latlon=T)
  plot(test, main="", xlim=c(0,2500))
  abline(h=0)
  r2.550.raw[i,1] <- summary(reg.sub.annual)$adj.r.squared #get the r2
}
```


### Local moran's I - cold 550

```{r subsample local moran cold 550, fig.width=14, fig.height=12, results='hide'}
table(carp.r$spatial.code.550)

par(mfrow = c(5,2))
par(mar=c(1,1,1,1))

## Check the local moran's results after sub-sampling
for (i in 1:10){
  sub <- carp.r %>% group_by(spatial.code.550) %>% sample_n(size=1)
  reg.sub.cold <- lm(log(sub$AAM)~sub$ColdTemp)
  test <- correlog(sub$longitude, sub$latitude, reg.sub.cold$residuals,
                   increment=50, resamp=500, latlon=T)
  plot(test, main="", xlim=c(0,2500))
  abline(h=0)
  r2.550.raw[i,2] <- summary(reg.sub.cold)$adj.r.squared #get the r2
}
```

We have seen that subsampling at 550 km would largely reduce the spatial autocorrelation in our dataset at low distances, even though we are only left with 12 data points.


## Compare the r2 values

```{r compare r2}
r2 <- data.frame(
  Time = c("Original", "Sub 250","Sub 550"),
  Annual = c(summary(lm.annual)$adj.r.squared, mean(unique(r2.250.raw[,1])),
             mean(unique(r2.550.raw[,1]))),
  Cold = c(summary(lm.cold)$adj.r.squared, mean(unique(r2.250.raw[,2])),
           mean(unique(r2.550.raw[,2])))
)
kable(r2)
```

However, subsampling at 550 km would reduce our R2 value as well, suggesting that the model would not fit for the sub-dataset.



## Latitudinal stratification

Now we would like to explore if stratified sub-sampling using latitude would reduce our spatial autocorrelation at low distances.

### one degree latitude bin - annual

```{r latitude one annual, fig.width=14, fig.height=12, results='hide'}

table(carp.r$lat.one)

par(mfrow = c(5,2))
par(mar=c(1,1,1,1))

for (i in 1:10){
  sub <- carp.r %>% group_by(lat.one) %>% sample_n(size=1)
  reg.sub.annual <- lm(log(sub$AAM)~sub$AnnualTemp)
  test <- correlog(sub$longitude, sub$latitude, reg.sub.annual$residuals,
                   increment=50, resamp=500, latlon=T)
  plot(test, main="", xlim=c(0,2500))
  abline(h=0)
}

dev.off()
```

### one degree latitude bin - cold

```{r latitude one cold, fig.width=14, fig.height=12, results='hide'}

table(carp.r$lat.one)

par(mfrow = c(5,2))
par(mar=c(1,1,1,1))

for (i in 1:10){
  sub <- carp.r %>% group_by(lat.one) %>% sample_n(size=1)
  reg.sub.cold <- lm(log(sub$AAM)~sub$ColdTemp)
  test <- correlog(sub$longitude, sub$latitude, reg.sub.cold$residuals,
                   increment=50, resamp=500, latlon=T)
  plot(test, main="", xlim=c(0,2500))
  abline(h=0)
}

dev.off()
```

* For some subsamples, the negative autocorrelation at 550 km is reduced.

* It seems that the South Ukarine data point is the main cause that we have negative spatial autocorrelation at around 550 km. Therefore, we ought to remove this datapoint from our analyses.



## Local moran's I without the South Ukarine data point

Now we would like to re-examine the local spatial autocorrelation with the South Ukarine data point removed.

### Remove the data point and construct the local moran's I

```{r SU removal model}
# Remove the data point for South Ukarine
carp.new <- carp.r[carp.r$location != "South Ukraine",]

# Define the model
lm.annual <- lm(log(carp.new$AAM)~carp.new$AnnualTemp) # Annual temperature
lm.cold <- lm(log(carp.new$AAM)~carp.new$ColdTemp) # Cold temperature

# See the results
summary(lm.annual)
summary(lm.cold)


## Local moran's I - Annual temperature
par(mfrow=c(2,1),mar=c(2,2,2,2))

# Use the coorelog function to develop the relationship
test <- correlog(carp.new$longitude, carp.new$latitude, lm.annual$residuals,
                 increment=50, resamp=500, latlon=T)

# Plot with the entire distance range
plot(test, main="Annual Average Temperature Regression Residuals - Removal")
abline(h=0)
text(17400, min(test$correlation)+1, "A", cex=1.5)

# Reduce the distance range to 2500 km
plot(test, main="", xlim=c(0,2500))
abline(h=0)
text(2500, min(test$correlation)+1, "B", cex=1.5)


## Local moran's I - Cold temperature
par(mfrow=c(2,1),mar=c(2,2,2,2))

# Use the coorelog function to develop the relationship
test <- correlog(carp.new$longitude, carp.new$latitude, lm.cold$residuals,
                 increment=50, resamp=500, latlon=T)

# Plot with the entire distance range
plot(test, main="Cold Quarter Temperature Regression Residuals - Removal")
abline(h=0)
text(17400, min(test$correlation)+1, "A", cex=1.5)

# Reduce the distance range to 2500 km
plot(test, main="", xlim=c(0,2500))
abline(h=0)
text(2500, min(test$correlation)+1, "B", cex=1.5)
```



## China Dataset analyses

Now let's look at the datapoints in China. There are 17 datapoints.

```{r china distribution}
## Subset the Chinese dataset
black.china <- carp.r[carp.r$china == "y",]

## Get the world data
world <- ne_countries(scale = "small", returnclass = "sf")

## Plots (china plot)
world %>% 
  filter(admin == "China" | admin =="Taiwan") %>%
  # select only China
  ggplot()+
  geom_sf()+
  geom_point(aes(x=longitude, y=latitude), data = black.china,
             size = 2, color = "darkred")+
  theme_bw()+
  xlab("Longitude") + ylab("Latitude")
```

Note that the datapoint outside of the Chinese region is "Northern China". It is calculated through geographical center.

### Global moran's I

```{r global china}
# Run the models
lm.annual.china <- lm(log(AAM)~AnnualTemp, data = black.china)
summary(lm.annual.china)
lm.cold.china <- lm(log(AAM)~ColdTemp, data = black.china)
summary(lm.cold.china)

## Make spatial dataframe
coords <- data.frame("long"=black.china[,14],"lat"=black.china[,13])
df <- data.frame(a = 1:nrow(black.china[14]))
spatial.data <- SpatialPointsDataFrame(coords,df,proj4string = tmin.1979@crs)

# Get a distance matrix from all points
dists <- spDists(spatial.data, longlat = TRUE)

## Run the Moran.I test on the residuals
Moran.annual <- Moran.I(lm.annual.china$residuals, dists)
Moran.cold <- Moran.I(lm.cold.china$residuals, dists)

global.moran <- data.frame(
  Model = c("Moran.annual", "Moran.cold"),
  Observed = c(Moran.annual$observed, Moran.cold$observed),
  Expected = c(Moran.annual$expected, Moran.cold$expected),
  sd = c(Moran.annual$sd, Moran.cold$sd),
  p.value = c(Moran.annual$p.value, Moran.cold$p.value)
)

kable(global.moran)
```

No global spatial autocorrelation in the Chinese dataset.


### Local moran's I - correlog

```{r correlog china}
## Annual temperature
par(mfrow=c(2,1),mar=c(4,4,2,2))

# Use the coorelog function to develop the relationship
test <- correlog(black.china$longitude,
                 black.china$latitude, lm.annual.china$residuals,
                 increment=50, resamp=500, latlon=T)

# Plot with the entire distance range
plot(test,
     main="Annual Average Temperature Regression Residuals for Chinese data")
abline(h=0)
# Reduce the distance range to 1500 km
plot(test, main="", xlim=c(0,1500))
abline(h=0)


## Cold temperature
par(mfrow=c(2,1),mar=c(4,4,2,2))
# Use the coorelog function to develop the relationship
test <- correlog(black.china$longitude, 
                 black.china$latitude, lm.cold.china$residuals,
                 increment=50, resamp=500, latlon=T)

# Plot with the entire distance range
plot(test,
     main="Cold Quarter Temperature Regression Residuals for Chinese data")
abline(h=0)

# Reduce the distance range to 1500 km
plot(test, main="", xlim=c(0,1500))
abline(h=0)
```


### Subsample at 250km for Chinese dataset

Now we subsample at 250km to reduce spatial autocorrelation.

```{r china sub 250, fig.width=14, fig.height=12, results='hide'}
table(black.china$spatial.code.250)

## Annual temperature
par(mfrow=c(5,2), mar=c(1,1,2,2))
for (i in 1:10){
  sub <- black.china %>% group_by(spatial.code.250) %>% sample_n(size=1)
  reg.sub.annual <- lm(log(sub$AAM)~sub$AnnualTemp)
  
  test <- correlog(sub$longitude, sub$latitude, reg.sub.annual$residuals,
                   increment=50, resamp=500, latlon=T)
  plot(test, main="", xlim=c(0,1500))
  abline(h=0)
}

## Cold temperature
par(mfrow=c(5,2), mar=c(1,1,2,2))
for (i in 1:10){
  sub <- black.china %>% group_by(spatial.code.250) %>% sample_n(size=1)
  reg.sub.cold <- lm(log(sub$AAM)~sub$ColdTemp)
  
  test <- correlog(sub$longitude, sub$latitude, reg.sub.cold$residuals,
                   increment=50, resamp=500, latlon=T)
  plot(test, main="", xlim=c(0,1500))
  abline(h=0)
}
```



## Conclusions

* There was no global spatial autocorrelation in the entire dataset, but when looking at local clustering, we saw a strong negative autocorrelation at around 550 km.

* We tried to subsample at 250 km, and 550 km. 220 km did not reduce the spatial autocorrelation we saw. 550 km did reduce that, but left us with too few data to fit a model.

* We then tried to subsample by latitudinal straitification. We found that the negative autocorrelation was reduced in some iterations (when South Ukarine was not selected). We hypothesized that particular datapoint is the cause.

* We removed the SU data point and ran the local moran's I again. This time, we have no local clustering at 550 km!
